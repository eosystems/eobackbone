'use strict';

angular.module('eoApp')

.controller(
  'sellRequestsController',
  ['$resource', '$scope', '$state', '$uibModal', '$loading', 'toastr', '$location',
    function($resource, $scope, $state, $uibModal, $loading, toastr, $location) {
    var Api = $resource("/api/sell_orders", {}, {
      create: {
        method: 'POST'
      }
    });

    // Retrieval
    $scope.totalPrice = 0.0;
    $scope.totalVolume = 0.0;
    $scope.sellPrice = 0.0;
    $scope.retrievalItems = function() {
      return Api.get({ form: $scope.retrievalForm }).$promise.then(function(data) {
        if (data.result) {
          $scope.totalPrice = data.result.total_price;
          $scope.sellPrice = data.result.sell_price;
          $scope.totalVolume = data.result.total_volume;
          $scope.items = data.result.order_details;
          toastr.success("Retrieval Success", "Success");
        }
      }, function(error) {
          toastr.error("Something Wrong.", "Error");
      });
    };

    // 申請ボタン
    $scope.requestConfirm = function() {
      var modalInstance = $uibModal.open({
        templateUrl: "<%= asset_path 'shared/simple_dialog.html' %>",
        controller: 'SimpleDialogController',
        backdrop: true,
        scope: $scope,
        resolve: {
          params: function() {
            return {
              title: 'Sell Request',
              message: 'Are you sure?'
            };
          }
        }
      });
      modalInstance.result.then(
        // cancel
        function(result) {
        },
        // request
        function(result) {
          toastr.info("Send Sell Request", "Request");

          Api.create({ form: $scope.retrievalForm }).$promise.then(function(data) {
            toastr.success("Request Accepted", "Success");

            $location.path("/orders");
          }, function(error) {
            toastr.error("Something wrong.", "Error");
          });
        }
      );
    };
  }]
);
