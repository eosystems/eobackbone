'use strict';

angular.module('eoApp')

.controller(
  'buyRequestsController',
  ['$resource', '$scope', '$state', '$uibModal', '$loading', 'toastr', '$location',
    function($resource, $scope, $state, $uibModal, $loading, toastr, $location) {
    var Api = $resource("/api/sell_orders", {}, {
      create: {
        method: 'POST'
      }
    });
    var TypesApi = $resource("/api/types", {});
    var DepartmentApi = $resource("/api/departments", {});
    var MarketPricesApi = $resource("/api/market_prices/:id", {
      id: '@id'
    }, {
      get: {
        method: 'GET'
      }
    });

    var that = this;
    $scope.requestItems = new Array();

    // 初期化
    var initialize = function() {
      // 部門
      DepartmentApi.get({}).$promise.then(function(data) {
        $scope.departments = data.results;
      });
    };

    initialize();

    $scope.addToRequestList = function(typeId) {
        MarketPricesApi.get(
          {
            id: typeId
          }
        ).$promise.then(function(data) {
          var item = new Object();
          item.type_name = data.item.type_name;
          item.type_id = data.item.type_id;
          item.quantity = 1;
          item.buy_unit_price = data.buy_max_price;
          item.buy_price = data.buy_max_price;
          item.sell_unit_price = data.sell_min_price;
          item.sell_price = data.sell_min_price;

          $scope.requestItems.push(item);

          toastr.info("Add to Request List" + " (" + item.type_name + ")", "Info");
        });
    };

    $scope.changeQuantity = function(row) {
      row.sell_price = row.sell_unit_price * row.quantity;
      row.buy_price = row.buy_unit_price * row.quantity;
    }

    $scope.removeRequestList = function(index) {
      $scope.requestItems.splice(index,1);
    }

    // Item Suggest
    $scope.currentItem = null;
    $scope.searchTypes = function(type_name) {
      TypesApi.get({ keyword: type_name }).$promise.then(function(data) {
        $scope.marketItems = data.results;
      });
    };

  }]
);
